autoforget rctest
: rctest ;

// add ndrop
// fix bug where apps which contain app_autoload.txt only run it if there is an app_autoload.txt file also
// is there a bug where an embedded app_autoload.txt which has no loaddone gets an error at eof?
// see if builtin classes have a 'new' method
: ndrop 0 do drop loop ;

// N_STRINGS N OString makeStr ... OString object
: makeStr
  -> OString str
  -> int nStrings
  do( 0 nStrings 1- )
    //i %d %nl
    str.append( i pick )
  +loop( -1 )
  ndrop( nStrings )
  str.release
;

: ninterpret
  new OString -> OString foo
  makeStr( foo )
  $evaluate( foo.get )
  //foo.get %s %nl
  foo.release
;

: obj  // obj TYPE_NAME INSTANCE_NAME  - defines obj var and creates instance
  256 string typeName
  blword -> typeName
  256 string instName
  blword -> instName
  r[ "new "  typeName " -> " typeName " " instName ]r ninterpret
;

: str  // STRING_PTR str INSTANCE_NAME  - defines OString var and creates instance & initializes value to STRING_PTR
  new OString -> OString instName
  blword instName.set
  r[ "new OString -> OString " instName.get " " instName.get ".set" ]r ninterpret
  instName.release
;


: showContainer
  <OIterable>.headIter -> OIter iter
  begin
    iter.next
  while
    2dup <OString>.get %s %bl <Object>.show %nl
  repeat
  dnull -> iter
;

: showContainerR
  <OIterable>.tailIter -> OIter iter
  begin
    iter.prev
  while
    2dup <OString>.get %s %bl <Object>.show %nl
  repeat
  dnull -> iter
;

: showArray
  <OArray>.headIter 2dup showContainer
  <OIter>.release
;

: showArrayR
  <OArray>.tailIter 2dup showContainerR
  <OIter>.release
;

: showList
  <OList>.headIter 2dup showContainer
  <OIter>.release
;

: showListR
  <OList>.tailIter 2dup showContainerR
  <OIter>.release
;

: showMap
  <OIntMap>.headIter -> OIntMapIter iter
  begin
    iter.nextPair
  while
    "key=" %s %d %bl 2dup <OString>.get %s %bl <Object>.show %nl
  repeat
  iter.release
;

: showMapR
  <OIntMap>.tailIter -> OIntMapIter iter
  begin
    iter.prevPair
  while
    "key=" %s %d %bl 2dup <OString>.get %s %bl <Object>.show %nl
  repeat
  iter.release
;

"alsatian" str dogA
"beagle" str dogB
"corgie" str dogC
obj OArray adogs
obj OList ldogs
obj OIntMap mdogs


: test
  "using arrays:\n" %s

  "empty\n" %s
  adogs showContainer  adogs showContainerR
  dogA adogs.push
  "one element\n" %s
  adogs showContainer  adogs showContainerR
  dogB adogs.push
  dogC adogs.push
  "three elements\n" %s
  adogs showContainer  adogs showContainerR


  %nl %nl
  "using lists:\n" %s

  "empty\n" %s
  ldogs showContainer  ldogs showContainerR
  dogC ldogs.addHead
  "one element\n" %s
  ldogs showContainer  ldogs showContainerR
  dogA ldogs.addTail
  dogB ldogs.addHead
  "three elements\n" %s
  ldogs showContainer  ldogs showContainerR


  %nl %nl
  "using maps:\n" %s
  "empty\n" %s
  mdogs showContainer  mdogs showContainerR
  dogA 1 mdogs.set
  "one element\n" %s
  mdogs showContainer  mdogs showContainerR
  dogB 2 mdogs.set
  dogC 3 mdogs.set
  "three elements\n" %s
  mdogs showContainer  mdogs showContainerR
  %nl %nl
;

#if 0

class: animal extends object
;class


class: zoo extends object
  OString name
  OArray cages
  
  // ZOO_NAME ...
  method: init
    new OString -> name
    new OArray -> cages
    name.set
  ;method
  
  method: delete
    super.delete
  ;method
  
  // CAGE_NAME ...
  method: addCage
    new OPair -> OPair newCage
    newCage.setA
    newCage cages.push
  ;method
  
  method: show
  ;method
  
  
;class

#endif


: cleanup
  dogA.release dogB.release dogC.release
  adogs.release
  ldogs.release
  mdogs.release
;

loaddone
